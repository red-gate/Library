{
  "Id": "ActionTemplates-35",
  "Name": "Redgate - Deploy from Package",
  "Description": "Uses Redgate's [DLM Automation](http://www.red-gate.com/dlma/productpage) to deploy a package containing a database schema (created by Redgate's DLM tools) to a SQL Server database, without a review step.\n\nRequires DLM Automation version 2.0.0.0 or later.\n\n*Version date: 23rd January, 2017*",
  "ActionType": "Octopus.Script",
  "Version": 6,
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "# Version date: 23rd January, 2017\r\n$ErrorActionPreference = 'Stop'\r\n$VerbosePreference = 'Continue'\r\n\r\n# Set process level FUR environment\r\n$env:REDGATE_FUR_ENVIRONMENT = \"Octopus Step Templates\"\r\n\r\n# Check if DLM Automation is installed.\r\n$dlmAutomationModule = Get-Module -ListAvailable -Name DLMAutomation\r\nif ($dlmAutomationModule -eq $null) { \r\n    throw \"Cannot find DLM Automation on your Octopus Tentacle. If DLM Automation is installed, try restarting the Tentacle service for it to be detected.\"\r\n}\r\n$currentVersion = $dlmAutomationModule.Version\r\n$minimumRequiredVersion = [version] '2.0.0.0'\r\nif ($currentVersion -lt $minimumRequiredVersion) { \r\n    throw \"This step requires DLM Automation version $minimumRequiredVersion or later. The current version is $currentVersion. The latest version can be found at http://www.red-gate.com/dlmas/download\"\r\n}\r\n\r\n# Check the parameters.\r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationTargetDatabaseName)) { throw \"You must enter a value for 'Target database name'.\" }\r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationTargetDatabaseServer)) { throw \"You must enter a value for 'Target SQL Server instance'.\" } \r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationNuGetDbPackageDownloadStepName)) { throw \"You must enter a value for 'Database package step'.\" } \r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationFilterPath)) { $DLMAutomationFilterPath = $null } \r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationCompareOptions)) { $DLMAutomationCompareOptions = $null } \r\n\r\n$queryBatchTimeout = 30\r\nif (![string]::IsNullOrWhiteSpace($DLMAutomationQueryBatchTimeout)) {\r\n    if (![int32]::TryParse($DLMAutomationQueryBatchTimeout , [ref]$queryBatchTimeout )) {\r\n        throw 'The query batch timeout must be a numerical value (in seconds).'\r\n    }\r\n    if ($queryBatchTimeout -lt 0) {\r\n        throw \"The query batch timeout can't be negative.\"\r\n    }\r\n}\r\n\r\n# Get the NuGet package installation directory path.\r\n$packageExtractPath = $OctopusParameters[\"Octopus.Action[$DLMAutomationNuGetDbPackageDownloadStepName].Output.Package.InstallationDirectoryPath\"]\r\nif($packageExtractPath -eq $null) {\r\n    throw \"The 'Database package download step' is not a 'Deploy a NuGet package' step: '$DLMAutomationNuGetDbPackageDownloadStepName'\"\r\n}\r\n\r\n# Directory containing the extracted database package.\r\n$databaseStatePath = Join-Path -path $packageExtractPath -childPath \"db\\state\" \r\n\r\n$targetDB = New-DlmDatabaseConnection -ServerInstance $DLMAutomationTargetDatabaseServer -Database $DLMAutomationTargetDatabaseName -Username $DLMAutomationTargetUsername -Password $DLMAutomationTargetPassword | Test-DlmDatabaseConnection\r\n$ignoreStaticData = $DLMAutomationIgnoreStaticData -eq \"True\"\r\n\r\n# Create database deployment resources from the NuGet package to the database\r\n\r\n$release = New-DlmDatabaseRelease  -Target $targetDB `\r\n                                -Source $databaseStatePath `\r\n                                -TransactionIsolationLevel $DLMAutomationTransactionIsolationLevel `\r\n                                -IgnoreStaticData:$ignoreStaticData `\r\n                                -FilterPath $DLMAutomationFilterPath `\r\n                                -SQLCompareOptions $DLMAutomationCompareOptions\r\n\r\n# Deploy the source schema to the target database.\r\nWrite-Host \"Timeout = $queryBatchTimeout\"\r\n$release | Use-DlmDatabaseRelease -DeployTo $targetDB -SkipPreUpdateSchemaCheck -QueryBatchTimeout $queryBatchTimeout\r\n\r\n",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.FeedId": null,
    "Octopus.Action.Package.PackageId": null
  },
  "Parameters": [
    {
      "Id": "d149637a-e9cd-472c-9474-fe584d126293",
      "Name": "DLMAutomationNuGetDbPackageDownloadStepName",
      "Label": "Database package step",
      "HelpText": "Select the step in this project which downloads the database package.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      },
      "Links": {}
    },
    {
      "Id": "b99bb38b-1441-41d0-b77e-f5bcc7da18fa",
      "Name": "DLMAutomationTargetDatabaseServer",
      "Label": "Target SQL Server instance",
      "HelpText": "The fully qualified SQL Server instance name for the target database.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "3ccbbd27-d6da-4ce3-9643-a3ac0ba61608",
      "Name": "DLMAutomationTargetDatabaseName",
      "Label": "Target database name",
      "HelpText": "The name of the database to deploy changes to. This must be an existing database.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "187d4be0-e3f1-4875-a2dc-500991c66b14",
      "Name": "DLMAutomationTargetUsername",
      "Label": "Username (optional)",
      "HelpText": "The SQL Server username used to connect to the database. If you leave this field and 'Password' blank, Windows authentication will be used to connect instead, using the account that runs the Tentacle service.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "a9315b03-76eb-4305-af89-426f43949a64",
      "Name": "DLMAutomationTargetPassword",
      "Label": "Password (optional)",
      "HelpText": "You must enter a password if you entered a username.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      },
      "Links": {}
    },
    {
      "Id": "3524dd56-c2bb-46a8-bde1-660ce0df9443",
      "Name": "DLMAutomationFilterPath",
      "Label": "Filter path (optional)",
      "HelpText": "Specify the location of a SQL Compare filter file (.scpf), which defines objects to include/exclude in the schema comparison. Filter files are generated by SQL Source Control.\n\nFor more help see [Using SQL Compare filters in DLM Automation](http://documentation.red-gate.com/display/SR1/Using+SQL+Compare+filters+in+SQL+Release).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "429e3bd7-2ffc-4b75-9e5a-1d6238bfca53",
      "Name": "DLMAutomationCompareOptions",
      "Label": "SQL Compare options (optional)",
      "HelpText": "Enter SQL Compare options to apply when generating the update script. Use a comma-separated list to enter multiple values. For more help see [Using SQL Compare options in DLM Automation](http://documentation.red-gate.com/display/SR1/Using+SQL+Compare+options+in+SQL+Release).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "45d7db3a-c029-4d6b-b581-d0926963a931",
      "Name": "DLMAutomationTransactionIsolationLevel",
      "Label": "Transaction isolation level (optional)",
      "HelpText": "Select the transaction isolation level to be used in deployment scripts.",
      "DefaultValue": "Serializable",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "Serializable\nSnapshot\nRepeatableRead\nReadCommitted\nReadUncommitted"
      },
      "Links": {}
    },
    {
      "Id": "2a26def6-86df-4c22-ab24-1fea809e67fc",
      "Name": "DLMAutomationIgnoreStaticData",
      "Label": "Ignore static data",
      "HelpText": "Exclude changes to static data when generating the deployment resources.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "cabe2159-39be-4689-a072-ee42d6f71d9d",
      "Name": "DLMAutomationQueryBatchTimeout",
      "Label": "Query batch timeout (in seconds)",
      "HelpText": "The execution timeout, in seconds, for each batch of queries in the update script. The default value is 30 seconds. A value of zero indicates no execution timeout.",
      "DefaultValue": "30",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    }
  ],
  "$Meta": {
    "ExportedAt": "2017-01-23T17:03:33.570Z",
    "OctopusVersion": "3.5.2",
    "Type": "ActionTemplate"
  }
}