{
  "Id": "ActionTemplates-34",
  "Name": "Redgate - Create Database Release",
  "Description": "Creates the resources (including the SQL update script) to deploy database changes using Redgate's [DLM Automation](http://www.red-gate.com/dlma/productpage), and exports them as Octopus artifacts so you can review the changes before deploying.\n\nRequires DLM Automation version 2.0.0.0 or later.\n\n*Version date: 23rd January, 2017*",
  "ActionType": "Octopus.Script",
  "Version": 11,
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "# Version date: 23rd January, 2017\r\n$ErrorActionPreference = 'Stop'\r\n$VerbosePreference = 'Continue'\r\n\r\n# Set process level FUR environment\r\n$env:REDGATE_FUR_ENVIRONMENT = \"Octopus Step Templates\"\r\n\r\n# Check if DLM Automation is installed.\r\n$dlmAutomationModule = Get-Module -ListAvailable -Name DLMAutomation\r\nif ($dlmAutomationModule -eq $null) { \r\n    throw \"Cannot find DLM Automation on your Octopus Tentacle. If DLM Automation is installed, try restarting the Tentacle service for it to be detected.\"\r\n}\r\n$currentVersion = $dlmAutomationModule.Version\r\n$minimumRequiredVersion = [version] '2.0.0.0'\r\nif ($currentVersion -lt $minimumRequiredVersion) { \r\n    throw \"This step requires DLM Automation version $minimumRequiredVersion or later. The current version is $currentVersion. The latest version can be found at http://www.red-gate.com/dlmas/download\"\r\n}\r\n\r\n# Check the parameters.\r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationDatabaseName)) { throw \"You must enter a value for 'Target database name'.\" }\r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationDatabaseServer)) { throw \"You must enter a value for 'Target SQL Server instance'.\" } \r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationNuGetDbPackageDownloadStepName)) { throw \"You must enter a value for 'Database package step'.\" }\r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationFilterPath)) { $DLMAutomationFilterPath = $null } \r\nif ([string]::IsNullOrWhiteSpace($DLMAutomationCompareOptions)) { $DLMAutomationCompareOptions = $null } \r\n\r\n# Get the NuGet package installation directory path.\r\n$packagePath = $OctopusParameters[\"Octopus.Action[$DLMAutomationNuGetDbPackageDownloadStepName].Output.Package.InstallationDirectoryPath\"]\r\nif($packagePath -eq $null) {\r\n    throw \"The 'Database package download step' is not a 'Deploy a NuGet package' step: '$DLMAutomationNuGetDbPackageDownloadStepName'\"\r\n}\r\n\r\n# Work out where the scripts folder from the downloaded NuGet package is.\r\n$databaseStatePath = Join-Path -Path $packagePath -ChildPath 'db\\state'\r\n\r\n# Constructing the unique export path.\r\n$projectId = $OctopusParameters[\"Octopus.Project.Id\"]\r\n$releaseNumber = $OctopusParameters[\"Octopus.Release.Number\"]\r\n$nugetPackageId = $OctopusParameters[\"Octopus.Action[$DLMAutomationNuGetDbPackageDownloadStepName].Package.NuGetPackageId\"]\r\n$exportPath = Join-Path (Join-Path (Join-Path $DLMAutomationDeploymentResourcesPath $projectId) $releaseNumber) $nugetPackageId\r\n\r\n# Make sure the directory we're about to create doesn't already exist, and delete any files if requested.\r\nif ((Test-Path $exportPath) -AND ((Get-ChildItem $exportPath | Measure-Object).Count -ne 0)) {\r\n    if ($DLMAutomationDeleteExistingFiles -eq 'True') {\r\n        Write-Host \"Deleting all files in $exportPath\"\r\n        rmdir $exportPath -Recurse -Force\r\n    } else {\r\n        throw \"The export path is not empty: $exportPath.  Select the 'Delete files in export folder' option to overwrite the existing folder contents.\"\r\n    }\r\n}\r\n\r\n# Determine whether or not to include identical objects in the report.\r\n$DLMAutomationIncludeIdenticalsInReport = $DLMAutomationIncludeIdenticalsInReport -eq \"True\"\r\n\r\n$targetDB = New-DlmDatabaseConnection -ServerInstance $DLMAutomationDatabaseServer -Database $DLMAutomationDatabaseName -Username $DLMAutomationDatabaseUsername -Password $DLMAutomationDatabasePassword | Test-DlmDatabaseConnection\r\n$ignoreStaticData = $DLMAutomationIgnoreStaticData -eq \"True\"\r\n\r\n# Create the deployment resources from the database to the NuGet package\r\n$release = New-DlmDatabaseRelease -Target $targetDB `\r\n                                  -Source $databaseStatePath `\r\n                                  -TransactionIsolationLevel $DLMAutomationTransactionIsolationLevel `\r\n                                  -IgnoreStaticData:$ignoreStaticData `\r\n                                  -FilterPath $DLMAutomationFilterPath `\r\n                                  -SQLCompareOptions $DLMAutomationCompareOptions `\r\n                                  -IncludeIdenticalsInReport:$DLMAutomationIncludeIdenticalsInReport \r\n\r\n# Export the deployment resources to disk\r\n$release | Export-DlmDatabaseRelease -Path $exportPath\r\n        \r\n# Import the changes summary, deployment warnings, and update script as Octopus artifacts, so you can review them.\r\nNew-OctopusArtifact \"$exportPath\\Reports\\Changes.html\"\r\nNew-OctopusArtifact \"$exportPath\\Reports\\Warnings.xml\"\r\nNew-OctopusArtifact \"$exportPath\\Update.sql\"\r\n",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.RunOnServer": "false",
    "Octopus.Action.Script.ScriptFileName": null,
    "Octopus.Action.Package.FeedId": null,
    "Octopus.Action.Package.PackageId": null
  },
  "Parameters": [
    {
      "Id": "cd9902ba-016d-481f-bb8c-1330f9866bd0",
      "Name": "DLMAutomationDeploymentResourcesPath",
      "Label": "Export path",
      "HelpText": "The path that the database deployment resources will be exported to.\n\nThis path is used in the \"Redgate - Deploy from Database Release\" step, and must be accessible to all tentacles used in database deployment steps.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "84f2095f-d8b1-4ebd-92d9-b46b7efa8c88",
      "Name": "DLMAutomationDeleteExistingFiles",
      "Label": "Delete files in export folder",
      "HelpText": "If the folder that the deployment resources are exported to isn't empty, this step will fail. Select this option to delete any files in the folder.",
      "DefaultValue": "True",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "47d3b0ee-35cc-4836-bc51-b0a384b5d2b5",
      "Name": "DLMAutomationNuGetDbPackageDownloadStepName",
      "Label": "Database package step",
      "HelpText": "Select the step in this project which downloads the database package.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "StepName"
      },
      "Links": {}
    },
    {
      "Id": "66db5c12-70da-400a-9e1a-9b5b50a723e3",
      "Name": "DLMAutomationDatabaseServer",
      "Label": "Target SQL Server instance",
      "HelpText": "The fully qualified SQL Server instance name for the target database.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "a457170b-348f-4f70-956e-5b30172e7fe0",
      "Name": "DLMAutomationDatabaseName",
      "Label": "Target database name",
      "HelpText": "The name of the database that the source schema (the database package) will be compared with to generate the deployment resources. This must be an existing database.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "84fa9f85-b5e9-45c7-8c0d-94ff0d78334c",
      "Name": "DLMAutomationDatabaseUsername",
      "Label": "Username (optional)",
      "HelpText": "The SQL Server username used to connect to the database. If you leave this field and 'Password' blank, Windows authentication will be used to connect instead, using the account that runs the Tentacle service.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "ed131934-95ef-4815-ab25-ceeb38f9cab6",
      "Name": "DLMAutomationDatabasePassword",
      "Label": "Password (optional)",
      "HelpText": "You must enter a password if you entered a username.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Sensitive"
      },
      "Links": {}
    },
    {
      "Id": "ea379978-2ff3-4762-af31-22804a9a0e83",
      "Name": "DLMAutomationFilterPath",
      "Label": "Filter path (optional)",
      "HelpText": "Specify the location of a SQL Compare filter file (.scpf), which defines objects to include/exclude in the schema comparison. Filter files are generated by SQL Source Control.\n\nFor more help see [Using SQL Compare filters in DLM Automation](http://documentation.red-gate.com/display/SR1/Using+SQL+Compare+filters+in+SQL+Release).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "5baa5eda-cf6b-490f-8b6d-ba3bc40b3dba",
      "Name": "DLMAutomationCompareOptions",
      "Label": "SQL Compare options (optional)",
      "HelpText": "Enter SQL Compare options to apply when generating the update script. Use a comma-separated list to enter multiple values. For more help see [Using SQL Compare options in DLM Automation](http://documentation.red-gate.com/display/SR1/Using+SQL+Compare+options+in+SQL+Release).",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      },
      "Links": {}
    },
    {
      "Id": "4bd40423-780e-471e-bfdc-f74761ba361a",
      "Name": "DLMAutomationTransactionIsolationLevel",
      "Label": "Transaction isolation level (optional)",
      "HelpText": "Select the transaction isolation level to be used in deployment scripts.",
      "DefaultValue": "Serializable",
      "DisplaySettings": {
        "Octopus.ControlType": "Select",
        "Octopus.SelectOptions": "Serializable\nSnapshot\nRepeatableRead\nReadCommitted\nReadUncommitted"
      },
      "Links": {}
    },
    {
      "Id": "95be2a81-b455-4a51-8732-15a81138883d",
      "Name": "DLMAutomationIgnoreStaticData",
      "Label": "Ignore static data",
      "HelpText": "Exclude changes to static data when generating the deployment resources.",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    },
    {
      "Id": "6c9015f1-8001-4214-8081-284c05b4f0ef",
      "Name": "DLMAutomationIncludeIdenticalsInReport",
      "Label": "Include identical objects in the change report",
      "HelpText": "By default, the change report only includes added, modified and removed objects. Choose this option to also include identical objects.",
      "DefaultValue": "False",
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      },
      "Links": {}
    }
  ],
  "$Meta": {
    "ExportedAt": "2017-01-23T17:09:04.572Z",
    "OctopusVersion": "3.5.2",
    "Type": "ActionTemplate"
  }
}